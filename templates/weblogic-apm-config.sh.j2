#!/bin/bash
function backup_file() {
    cp -a "${1}" "${1}.$(date --iso-8601=seconds)"
}
ebs_fs_ne_path={{ ebs_fs_ne_path  }}
ebs_weblogic_config= {{ ebs_run_domain_home}}/config/config.xml
echo "Backuping up Weblogic Config file"
backup_file ${ebs_weblogic_config}
apm_instrumentation_path="${ebs_fs_ne_path}/apmagent/lib/system/ApmAgentInstrumentation.jar"
apm_startup_arg="-javaagent:${apm_instrumentation_path}"
server_name="oafm_server1"
echo "Locating startup arguments for ${server_name}"
server_startup_args=$(xmlstarlet sel -N d=http://xmlns.oracle.com/weblogic/domain \
                    -t -m "/d:domain/d:server[d:name='${server_name}']" \
                    -v 'd:server-start/d:arguments' $config_path)
if [[ $server_startup_args =~ "ApmAgentInstrumentation.jar" ]]; then
    echo "Found existing APM installation.  Updating arguments."
    updated_server_startup_args="${server_startup_args//(-javaagent:.*ApmAgentInstrumentation\.jar)+/${apm_startup_arg}/}"
else
    echo "No prior installation found.  Adding APM startup arguments."
    updated_server_startup_args="${server_startup_args} ${apm_startup_arg}"
fi
xmlstarlet edit -N d=http://xmlns.oracle.com/weblogic/domain \
    --update "/d:domain/d:server[d:name='${server_name}']/d:server-start/d:arguments" \
    --value $updated_server_startup_args $config_path
echo $server_startup_args
echo $updated_server_startup_args